{% assign section_id = 'shopify-section-' | append: section.id %}
{% comment %} 
  title：选对答案时标题  动态传入
  desc：选对答案时描述  动态传入
  title2：未选对答案时标题  动态传入
  desc2：未选对答案时描述  动态传入
  type: 1： 答题卡 2：评论区 3: 悬浮的sign up
  email_placeholder: email输入提示
  email_error:  email错误提示
  plocy_err: 未勾选协议错误提示
  button_txt: 按钮文案
  right_answer: 正确答案HTML 动态传入
  agree_txt: 协议文案
  
{% endcomment %}
<style>
.live-chat-popup-div {
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,.4);
  position: fixed;
  left: 0;
  top: 0;
  z-index: 199;
  display: none;
}
.mach-live-chat-popup {
  width: 95%;
  max-width: 900px;
  background: #FFFFFF;
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  padding: 50px 100px;
  text-align: center;
}
.live-chat-popup-title {
  font-weight: 500;
  font-size: 3.125vw;
  line-height: 3.125vw;
  color: #1D1D1F;
}
.live-chat-popup-desc {
  font-weight: 400;
  font-size: 18px;
  line-height: 24px;
  color: #1D1D1F;
  margin: 30px 0;
}
.live-chat-popup-user {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.popup-user-dom-div {
  width: 50%;
  margin: 0 15px;
}
.popup-user-form {
  width: 100%;
  margin: 0 15px;
}

.live-chat-pupup-input,.live-chat-pupup-submit, .live-chat-pupup-okey {
  width: 100%;
  max-width: 500px;
  height: 82px;
  font-weight: 400;
  font-size: 24px;
  color: #86868B;
  background: #F5F5F7;
  border-radius: 80px;
  display: flex;
  justify-content: center;
  padding: 0 20px;
  margin: 0 auto 20px auto;
  border: none;
}
.live-chat-pupup-input {
  font-size: 20px;
  font-weight: 600;
}
.live-chat-pupup-submit,.live-chat-pupup-okey {
  color: #fff;
  background: #EF3340;
  align-items: center;
  cursor: pointer;
}
.live-chat-pupup-okey {
  margin: 20px auto;
}
.live-chat-pupup-submit[disabled] {
  background-color: #86868B;
	pointer-events: none;
	cursor: not-allowed;
}
.contract-agree {
  display: flex;
  justify-content: center;
  align-items: center;
  color: #6E6E73;
  font-size: 12px;
  line-height: 20px;
}
.agree-checkbox {
  width: 18px;
  height: 18px;
  border: 1px solid #6E6E73;
  margin-right: 12px;
}
.live-popup-close {
  position: absolute;
  top: 12px;
  right: 12px;
  cursor: pointer;
}
.error-tips {
  height: 20px;
  text-align: center;
  font-size: 13px;
  color: #EF3340;
}

.live-chat-popup-div .step-answer-item{
  max-width: 260px;
  height: 320px;
  border-color: #EF3340;
  margin: 0 auto;
}
.right_answer_text {
  font-size: 20px;
  line-height: 40px;
  text-align: center;
  color: #EF3340;
}
.agree-checkbox-tips a {
  color: #6E6E73;
  text-decoration: underline;
}
@media(max-width: 769px) {
  .mach-live-chat-popup {
    width: 90%;
    height: 90vh;
    padding: 30px 15px;
  }
  .live-chat-popup-title {
    font-size: 32px;
    line-height: 32px;
  }
  .live-chat-pupup-input {
    font-size: 14px;
  }
  .live-chat-pupup-input,.live-chat-pupup-submit, .live-chat-pupup-okey {
    width: 90%;
    height: 60px;
  }
  .live-chat-popup-div .step-answer-item{
    margin: 0 auto 20px auto;
    width: 90%;
    max-width: 100%;
    height: 74px;
    padding: 10px 20px;
  }
  .live-chat-popup-user {
    display: block;
  }
  .popup-user-dom-div {
    width: 100%;
    margin: 0;
  }
  .popup-user-form {
    margin: 0;
  }
  .right_answer_text {
    width: 90%;
    margin: 0 auto;
    text-align: left;
  }
  .agree-checkbox-tips {
    display: inline-block;
    max-width: 80%;
  }
}

</style>
<div class="live-chat-popup-div">
  <div class="mach-live-chat-popup">
    <div class="live-chat-popup-title"></div>
    <div class="live-chat-popup-desc"></div>
    <div class="live-chat-popup-user">
      <div class="popup-user-dom-div">
        <div class="right_answer_text">{{ Right_Answer }}</div>
        <div class="popup-user-dom"></div>
      </div>
      <div class="popup-user-form">
        <input type="text" class="live-chat-pupup-input live-chat-pupup-email" placeholder="{{ email_placeholder }}" />
        <button class="live-chat-pupup-submit"></button>
        <div class="contract-agree">
          <input type="checkbox" class="agree-checkbox" />
          <span class="agree-checkbox-tips">{{ agree_txt }}</span>
        </div>
        <div class="error-tips"></div>
      </div>
    </div>

    <button class="live-chat-pupup-okey"></button>

    <svg class="live-popup-close" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path fill-rule="evenodd" clip-rule="evenodd" d="M10 1.81818C5.48131 1.81818 1.81818 5.48131 1.81818 10C1.81818 14.5187 5.48131 18.1818 10 18.1818C14.5187 18.1818 18.1818 14.5187 18.1818 10C18.1818 5.48131 14.5187 1.81818 10 1.81818ZM0 10C0 4.47715 4.47715 0 10 0C15.5228 0 20 4.47715 20 10C20 15.5228 15.5228 20 10 20C4.47715 20 0 15.5228 0 10Z" fill="#86868B"/>
      <path fill-rule="evenodd" clip-rule="evenodd" d="M7.07092 12.929C6.7159 12.5739 6.7159 11.9983 7.07092 11.6433L11.6433 7.07089C11.9984 6.71587 12.574 6.71587 12.929 7.07089C13.284 7.42591 13.284 8.00152 12.929 8.35654L8.35657 12.929C8.00155 13.284 7.42595 13.284 7.07092 12.929Z" fill="#86868B"/>
      <path fill-rule="evenodd" clip-rule="evenodd" d="M7.07092 7.07104C7.42595 6.71602 8.00155 6.71602 8.35657 7.07104L12.929 11.6435C13.284 11.9985 13.284 12.5741 12.929 12.9291C12.574 13.2841 11.9984 13.2841 11.6433 12.9291L7.07092 8.35669C6.7159 8.00167 6.7159 7.42606 7.07092 7.07104Z" fill="#86868B"/>
    </svg>
  </div>
</div>

<script>
$(function() {
  $('#{{section_id}} .live-chat-popup-div').on('show-event', function(event,{ email, title, desc, button_txt, right_answer }) {
    $(this).find('.live-chat-popup-title').text(title)
    $(this).find('.live-chat-popup-desc').text(desc)
    if(!!right_answer) {
      $(this).find('.popup-user-dom-div').show()
      $(this).find('.popup-user-dom').html(right_answer)
    }else {
      $(this).find('.popup-user-dom-div').hide()
    }
    if(!!email) {
      $(this).find('.popup-user-form').hide()
      $(this).find('.live-chat-pupup-okey').show()
      $(this).find('.live-chat-pupup-okey').text(button_txt)
    }else {
      $(this).find('.popup-user-form').show()
      $(this).find('.live-chat-pupup-okey').hide()
      $(this).find('.live-chat-pupup-submit').text(button_txt)
      let live_chat_email = $.cookie('live_chat_email')
      if(live_chat_email) $('.live-chat-pupup-email').val(live_chat_email)
    }
    $(this).show()
  })

  function wellDone() {
    if($('#{{ section_id }} .popup-user-dom-div').css('display') == 'block') {
      return 'wrong answer'
    }else {
      return 'well done'
    }
  }

  $('#{{section_id}} .live-chat-pupup-okey').click(function(e) {
    e.stopPropagation();
    e.preventDefault();
    $(document).trigger('mach_popup_close', { type: '{{ type }}' })
    $('#{{section_id}} .live-chat-popup-div').hide()
    {% if type == 1 %}
    dataLayer.push({
      "event": "uaEvent", 
      "eventCategory": 'answer_questions',
      "eventAction": 'Okay',
      "eventLabel": '{{ page.handle }}'
    })
    window.dataLayer.push({ "event_parameters": null });
    window.dataLayer.push({
      "event": "ga4Event",
      "event_name": "answer_questions",
      "event_parameters": {
        "page_group": '{{ page.handle }}',
        "info": wellDone(),
        "action": 'Okay'
      }
    })
    {% endif %}
  })

  $('#{{section_id}} .live-chat-pupup-submit').click(function(e) {
    e.stopPropagation();
    e.preventDefault();
    const email_err = '{{ email_error }}';
    const plocy_err = '{{ plocy_err }}';
    const email = $('#{{section_id}} .live-chat-pupup-email').val()
    const check = $('#{{section_id}} .agree-checkbox').prop('checked')
    const reg = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    if(!reg.test(email)) {
      $('#{{section_id}} .error-tips').css({ visibility: 'visible' }).text(email_err)
      return;
    }
    if(!check) {
      $('#{{section_id}} .error-tips').css({ visibility: 'visible' }).text(plocy_err)
      return;
    }
    $('#{{section_id}} .error-tips').css({ visibility: 'hidden' })

    $(this).prop("disabled", true);

    $(document).trigger('mach_popup_submit', { type: '{{ type }}', email: email })

    setTimeout(() => { 
      $(this).prop("disabled", false);
      $('.live-chat-pupup-email').val('')
    }, 3000)

    {% if type == 1 %}
      dataLayer.push({
        "event": "uaEvent", 
        "eventCategory": 'subscribe',
        "eventAction": '{{ section.settings.deals_type }}',
        "eventLabel": "quiz"
      })

      window.dataLayer.push({ "event_parameters": null });
      window.dataLayer.push({
        "event": "ga4Event",
        "event_name": "subscribe",
        "event_parameters": {
          "page_group": '{{ section.settings.deals_type }}',
          "position":"quiz",
          "info": wellDone()
        }
      })
    {% endif %}

    {% if type == 2 %}
      dataLayer.push({
        "event": "uaEvent", 
        "eventCategory": 'comment',
        "eventAction": 'submit',
        "eventLabel": '{{ page.handle }}',
      })
      window.dataLayer.push({ "event_parameters": null });
      window.dataLayer.push({
        "event": "ga4Event",
        "event_name": "comment",
        "event_parameters": {
          "page_group": '{{ page.handle }}', 
          "action": 'submit' 
        }
      })
    {% endif %}

    {% if type == 3 %}
      dataLayer.push({
        "event": "uaEvent", 
        "eventCategory": 'subscribe',
        "eventAction": '{{ section.settings.deals_type }}',
        "eventLabel": "sticky"
      })

      window.dataLayer.push({ "event_parameters": null });
      window.dataLayer.push({
        "event": "ga4Event",
        "event_name": "subscribe",
        "event_parameters": {
          "page_group": '{{ section.settings.deals_type }}',
          "position":"sticky",
          "info": ""
        }
      })
    {% endif %}

  })

  $('#{{section_id}} .live-popup-close').click(function() {
    $('#{{section_id}} .live-chat-popup-div').hide()
    $('.live-chat-pupup-email').val('')
  })
})
</script>